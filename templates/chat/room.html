{% extends 'base.html' %}
{% block content %}
<head>
    <title>Chat Room</title>
    <style>
        .chat-box {
            width: 80%;
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }
        .msg {
            margin: 5px 0;
        }
        .me {
            text-align: right;
            color: blue;
        }
        .other {
            text-align: left;
            color: green;
        }
    </style>

    <script>
        function loadMessages() {
            fetch("/chat/room/{{ room.id }}/messages/")
            .then(response => response.json())
            .then(data => {
                let box = document.getElementById("chat-box");
                box.innerHTML = "";

                data.forEach(m => {
                    let div = document.createElement("div");
                    div.className = "msg";

                    let isMe = m.sender__username === "{{ request.user.username }}";
                    div.classList.add(isMe ? "me" : "other");

                    div.textContent = m.sender__username + ": " + m.text;
                    box.appendChild(div);
                });

                box.scrollTop = box.scrollHeight;
            });
        }

        function sendMessage() {
            let text = document.getElementById("text").value;

            fetch("/chat/room/{{ room.id }}/send/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({ "text": text })
            })
            .then(() => {
                document.getElementById("text").value = "";
                loadMessages();
            });
        }

        setInterval(loadMessages, 1000); // refresh every 1 sec
        window.onload = loadMessages;
    </script>
</head>

<body>

<h2>Chat with 
    {% if request.user == room.user1 %}
        {{ room.user2.username }}
    {% else %}
        {{ room.user1.username }}
    {% endif %}
</h2>

<div id="chat-box" class="chat-box"></div>

<input type="text" id="text" placeholder="Type message..." style="width:70%">
<button onclick="sendMessage()">Send</button>

</body>
{% endblock %}
